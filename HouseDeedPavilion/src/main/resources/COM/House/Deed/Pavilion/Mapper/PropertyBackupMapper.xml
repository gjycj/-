<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="COM.House.Deed.Pavilion.Mapper.PropertyBackupMapper">

    <resultMap id="BaseResultMap" type="COM.House.Deed.Pavilion.Entity.PropertyBackup">
        <id column="id" property="id"/>
        <result column="original_id" property="originalId"/>
        <result column="name" property="name"/>
        <result column="address" property="address"/>
        <result column="developer" property="developer"/>
        <result column="property_type" property="propertyType"/>
        <result column="completion_year" property="completionYear"/>
        <result column="property_company" property="propertyCompany"/>
        <result column="property_fee" property="propertyFee"/>
        <result column="description" property="description"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="backup_time" property="backupTime"/>
        <result column="delete_reason" property="deleteReason"/>
        <result column="deleted_by" property="deletedBy"/>
    </resultMap>

    <!-- 按ID查询 -->
    <select id="selectById" parameterType="Long" resultMap="BaseResultMap">
        SELECT *
        FROM property_backup
        WHERE id = #{id}
    </select>

    <!-- 按原楼盘ID查询 -->
    <select id="selectByOriginalId" parameterType="Long" resultMap="BaseResultMap">
        SELECT *
        FROM property_backup
        WHERE original_id = #{originalId}
        ORDER BY backup_time DESC
    </select>

    <!-- 修正parameterType为全限定类名 -->
    <select id="selectByCondition"
            parameterType="COM.House.Deed.Pavilion.DTO.PropertyBackupQueryDTO"
            resultMap="BaseResultMap">
        SELECT * FROM property_backup
        <where>
            <if test="originalId != null">AND original_id = #{originalId}</if>
            <if test="nameLike != null and nameLike != ''">AND name LIKE CONCAT('%', #{nameLike}, '%')</if>
            <if test="addressLike != null and addressLike != ''">AND address LIKE CONCAT('%', #{addressLike}, '%')</if>
            <if test="backupTimeStart != null">AND backup_time >= #{backupTimeStart}</if>
            <if test="backupTimeEnd != null">AND backup_time &lt;= #{backupTimeEnd}</if>
            <if test="deletedBy != null">AND deleted_by = #{deletedBy}</if>
        </where>
        ORDER BY backup_time DESC
    </select>

    <!-- 新增备份 -->
    <insert id="insert" parameterType="COM.House.Deed.Pavilion.Entity.BuildingBackup" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO property_backup (original_id, name, address, developer, property_type, completion_year,
                                     property_company, property_fee, description, longitude, latitude,
                                     created_at, updated_at, created_by, updated_by, backup_time,
                                     delete_reason, deleted_by)
        VALUES (#{originalId}, #{name}, #{address}, #{developer}, #{propertyType}, #{completionYear},
                #{propertyCompany}, #{propertyFee}, #{description}, #{longitude}, #{latitude},
                #{createdAt}, #{updatedAt}, #{createdBy}, #{updatedBy}, #{backupTime},
                #{deleteReason}, #{deletedBy})
    </insert>

    <!-- 单个删除 -->
    <delete id="deleteById" parameterType="Long">
        DELETE
        FROM property_backup
        WHERE id = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds" parameterType="java.util.List">
        DELETE FROM property_backup WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </delete>

</mapper>