<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="COM.House.Deed.Pavilion.Mapper.VisitRecordBackupMapper">

    <!-- 补充：通用结果集映射（BaseResultMap），关联表字段与实体类属性 -->
    <resultMap id="BaseResultMap" type="COM.House.Deed.Pavilion.Entity.VisitRecordBackup">
        <!-- 主键字段（与原带看记录ID一致） -->
        <id column="id" property="id"/>
        <!-- 原带看记录业务字段 -->
        <result column="house_id" property="houseId"/>
        <result column="customer_id" property="customerId"/>
        <result column="agent_id" property="agentId"/>
        <result column="visit_time" property="visitTime"/>
        <result column="feedback" property="feedback"/>
        <result column="next_plan" property="nextPlan"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <!-- 备份相关字段 -->
        <result column="backup_time" property="backupTime"/>
        <result column="backup_by" property="backupBy"/>
    </resultMap>

    <!-- 新增带看记录备份 -->
    <insert id="insert" parameterType="COM.House.Deed.Pavilion.Entity.VisitRecordBackup">
        INSERT INTO visit_record_backup (
        id,
        house_id,
        customer_id,
        agent_id,
        visit_time,
        feedback,
        next_plan,
        created_at,
        updated_at,
        created_by,
        updated_by,
        backup_time,
        backup_by
        ) VALUES (
        #{id},
        #{houseId},
        #{customerId},
        #{agentId},
        #{visitTime},
        #{feedback},
        #{nextPlan},
        #{createdAt},
        #{updatedAt},
        #{createdBy},
        #{updatedBy},
        NOW(),
        #{backupBy}
        )
        <!-- 备份时间自动填充当前时间 -->
    </insert>

    <!-- 1. 根据ID查询备份记录 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM visit_record_backup WHERE id = #{id}
    </select>

    <!-- 2. 根据原带看记录ID查询备份 -->
    <select id="selectByVisitRecordId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM visit_record_backup WHERE id = #{visitRecordId}
    </select>

    <!-- 3. 根据客户ID查询其相关的带看备份记录 -->
    <select id="selectByCustomerId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM visit_record_backup
        WHERE customer_id = #{customerId}
        ORDER BY backup_time DESC
    </select>

    <!-- 4. 分页查询所有带看备份记录 -->
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT * FROM visit_record_backup
        ORDER BY backup_time DESC
    </select>

    <!-- 新增：按备份时间范围查询（核心补充） -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT * FROM visit_record_backup
        <where>
            <!-- 动态条件：支持单独传startTime/endTime或同时传 -->
            <if test="startTime != null">
                AND backup_time >= #{startTime}
            </if>
            <if test="endTime != null">
                AND backup_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY backup_time DESC  <!-- 最新删除的记录优先 -->
    </select>

    <!-- 新增：删除备份记录 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM visit_record_backup WHERE id = #{id}
    </delete>

</mapper>
