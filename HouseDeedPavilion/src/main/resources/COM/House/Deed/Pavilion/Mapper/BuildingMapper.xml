<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 注意：namespace需与Mapper接口全类名一致（包名大写按你的实际规范） -->
<mapper namespace="COM.House.Deed.Pavilion.Mapper.BuildingMapper">

    <!-- 新增楼栋（优化后） -->
    <insert id="insert"
            parameterType="COM.House.Deed.Pavilion.Entity.Building"
            useGeneratedKeys="true" keyProperty="id">        <!-- 开启自增主键支持 --> <!-- 绑定实体类的id字段（回填ID到该字段） -->
        INSERT INTO building (
        property_id, name, total_floor, unit_count, description,
        created_by, updated_by
        ) VALUES (
        #{propertyId}, #{name}, #{totalFloor}, #{unitCount}, #{description},
        #{createdBy}, #{updatedBy}
        )
    </insert>

    <!-- 注意参数名与方法参数一致 -->
    <select id="selectByNameAndPropertyId" resultType="COM.House.Deed.Pavilion.Entity.Building">
        SELECT *
        FROM `building`
        WHERE name = #{name}
          AND property_id = #{propertyId}
    </select>

    <!-- 根据ID查询楼栋 -->
    <select id="selectById" parameterType="java.lang.Long" resultType="COM.House.Deed.Pavilion.Entity.Building">
        SELECT id,
               property_id,
               name,
               total_floor,
               unit_count,
               description,
               created_at,
               updated_at,
               created_by,
               updated_by
        FROM building
        WHERE id = #{id}
    </select>

    <!-- 根据楼盘ID查询楼栋（分页） -->
    <select id="selectByPropertyId" parameterType="java.lang.Long" resultType="COM.House.Deed.Pavilion.Entity.Building">
        SELECT id,
               property_id,
               name,
               total_floor,
               unit_count,
               description,
               created_at,
               updated_at,
               created_by,
               updated_by
        FROM building
        WHERE property_id = #{propertyId}
        ORDER BY name ASC
    </select>

    <!-- 多条件分页查询楼栋 -->
    <select id="selectByCondition" parameterType="COM.House.Deed.Pavilion.DTO.BuildingQueryDTO"
            resultType="COM.House.Deed.Pavilion.Entity.Building">
        SELECT
        id, property_id, name, total_floor, unit_count, description,
        created_at, updated_at, created_by, updated_by
        FROM building
        <where>
            <!-- 按楼盘ID筛选（精确匹配） -->
            <if test="propertyId != null">
                AND property_id = #{propertyId}
            </if>
            <!-- 楼栋名称模糊查询 -->
            <if test="nameLike != null and nameLike != ''">
                AND name LIKE CONCAT('%', #{nameLike}, '%')
            </if>
            <!-- 总层数范围查询 -->
            <if test="totalFloorMin != null and totalFloorMax != null">
                AND total_floor BETWEEN #{totalFloorMin} AND #{totalFloorMax}
            </if>
            <if test="totalFloorMin != null and totalFloorMax == null">
                AND total_floor &gt;= #{totalFloorMin}  <!-- ">= "转义 -->
            </if>
            <if test="totalFloorMin == null and totalFloorMax != null">
                AND total_floor &lt;= #{totalFloorMax}  <!-- "<= "转义 -->
            </if>
        </where>
        ORDER BY property_id ASC, name ASC
    </select>

    <!-- 根据ID更新楼栋 -->
    <update id="updateById" parameterType="COM.House.Deed.Pavilion.Entity.Building">
        UPDATE building
        <set>
            <if test="propertyId != null">property_id = #{propertyId},</if>
            <if test="name != null">name = #{name},</if>
            <if test="totalFloor != null">total_floor = #{totalFloor},</if>
            <if test="unitCount != null">unit_count = #{unitCount},</if>
            <if test="description != null">description = #{description},</if>
            updated_at = NOW(),  <!-- 自动更新时间 -->
            <if test="updatedBy != null">updated_by = #{updatedBy}</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除楼栋 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE
        FROM building
        WHERE id = #{id}
    </delete>

</mapper>