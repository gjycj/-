<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 命名空间与Mapper接口全路径一致 -->
<mapper namespace="COM.House.Deed.Pavilion.Mapper.HouseMapper">

    <!-- 通用结果集映射（复用字段映射规则） -->
    <resultMap id="BaseResultMap" type="COM.House.Deed.Pavilion.Entity.House">
        <id column="id" property="id"/>
        <result column="building_id" property="buildingId"/>
        <result column="house_number" property="houseNumber"/>
        <result column="layout" property="layout"/>
        <result column="area" property="area"/>
        <result column="inner_area" property="innerArea"/>
        <result column="floor" property="floor"/>
        <result column="total_floor" property="totalFloor"/>
        <result column="orientation" property="orientation"/>
        <result column="decoration" property="decoration"/>
        <result column="price" property="price"/>
        <result column="owner_price" property="ownerPrice"/>
        <result column="description" property="description"/>
        <result column="agent_id" property="agentId"/>
        <result column="is_valid" property="isValid"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="house_type" property="houseType"
                typeHandler="COM.House.Deed.Pavilion.Handler.HouseTypeEnumHandler"/>
        <result column="status" property="status"
                typeHandler="COM.House.Deed.Pavilion.Handler.HouseStatusEnumHandler"/>
    </resultMap>

    <!-- 1. 新增房源 -->
    <insert id="insert" parameterType="COM.House.Deed.Pavilion.Entity.House"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO house (
        building_id,
        house_number,
        layout,
        area,
        inner_area,
        floor,
        total_floor,
        orientation,
        decoration,
        house_type,
        price,
        status,
        owner_price,
        description,
        agent_id,
        is_valid,
        created_at,
        updated_at,
        created_by,
        updated_by
        ) VALUES (
        #{buildingId},
        #{houseNumber},
        #{layout},
        #{area},
        #{innerArea},
        #{floor},
        #{totalFloor},
        #{orientation},
        #{decoration},
        #{houseType.code},  <!-- 取枚举的code值存入数据库 -->
        #{price},
        #{status.code},     <!-- 取枚举的code值存入数据库 -->
        #{ownerPrice},
        #{description},
        #{agentId},
        #{isValid},
        #{createdAt},
        #{updatedAt},
        #{createdBy},
        #{updatedBy}
        )
    </insert>

    <!-- 2. 根据ID查询房源 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        id,
        building_id,
        house_number,
        layout,
        area,
        inner_area,
        floor,
        total_floor,
        orientation,
        decoration,
        house_type,
        price,
        status,
        owner_price,
        description,
        agent_id,
        is_valid,
        created_at,
        updated_at,
        created_by,
        updated_by
        FROM house
        WHERE id = #{id}
        AND is_valid = 1  <!-- 只查询有效数据 -->
    </select>

    <!-- HouseMapper.xml 中添加以下内容 -->
    <!-- 统计指定经纪人的有效房源数量 -->
    <select id="countByAgentIdAndValid" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM house
        WHERE agent_id = #{agentId}  <!-- 匹配经纪人ID -->
        AND is_valid = 1  <!-- 只统计有效房源 -->
    </select>

    <!-- 3. 根据楼栋ID和门牌号查询（唯一性校验） -->
    <select id="selectByBuildingIdAndHouseNumber" resultMap="BaseResultMap">
        SELECT
        id,
        building_id,
        house_number
        FROM house
        WHERE building_id = #{buildingId}
        AND house_number = #{houseNumber}
        AND is_valid = 1  <!-- 只校验有效数据 -->
        <if test="excludeId != null">
            AND id != #{excludeId}  <!-- 更新时排除自身 -->
        </if>
    </select>


    <!-- 4. 根据ID更新房源 -->
    <update id="updateById" parameterType="COM.House.Deed.Pavilion.Entity.House">
        UPDATE house
        <set>
            <if test="buildingId != null">building_id = #{buildingId},</if>
            <if test="houseNumber != null">house_number = #{houseNumber},</if>
            <if test="layout != null">layout = #{layout},</if>
            <if test="area != null">area = #{area},</if>
            <if test="innerArea != null">inner_area = #{innerArea},</if>
            <if test="floor != null">floor = #{floor},</if>
            <if test="totalFloor != null">total_floor = #{totalFloor},</if>
            <if test="orientation != null">orientation = #{orientation},</if>
            <if test="decoration != null">decoration = #{decoration},</if>
            <if test="houseType != null">house_type = #{houseType.code},</if>
            <if test="price != null">price = #{price},</if>
            <if test="status != null">status = #{status.code},</if>
            <if test="ownerPrice != null">owner_price = #{ownerPrice},</if>
            <if test="description != null">description = #{description},</if>
            <if test="agentId != null">agent_id = #{agentId},</if>
            <if test="isValid != null">is_valid = #{isValid},</if>
            updated_at = #{updatedAt},
            updated_by = #{updatedBy}
        </set>
        WHERE id = #{id}
    </update>

    <!-- 5. 多条件分页查询 -->
    <select id="selectByCondition" parameterType="COM.House.Deed.Pavilion.DTO.HouseQueryDTO" resultMap="BaseResultMap">
        SELECT
        id,
        building_id,
        house_number,
        layout,
        area,
        inner_area,
        floor,
        total_floor,
        orientation,
        decoration,
        house_type,
        price,
        status,
        owner_price,
        description,
        agent_id,
        is_valid,
        created_at,
        updated_at,
        created_by,
        updated_by
        FROM house
        WHERE is_valid = 1
        <!-- 动态条件拼接 -->
        <if test="buildingId != null">AND building_id = #{buildingId}</if>
        <if test="houseNumber != null and houseNumber != ''">
            AND house_number LIKE CONCAT('%', #{houseNumber}, '%')
        </if>
        <if test="layout != null and layout != ''">
            AND layout LIKE CONCAT('%', #{layout}, '%')
        </if>
        <if test="houseType != null">AND house_type = #{houseType}</if>
        <if test="priceStart != null">AND price >= #{priceStart}</if>
        <if test="priceEnd != null">AND price &lt;= #{priceEnd}</if>
        <if test="status != null">AND status = #{status}</if>
        <if test="floorStart != null">AND floor >= #{floorStart}</if>
        <if test="floorEnd != null">AND floor &lt;= #{floorEnd}</if>
        <if test="agentId != null">AND agent_id = #{agentId}</if>
        <!-- 排序规则：按更新时间倒序 -->
        ORDER BY updated_at DESC
    </select>

    <!-- 6. 根据楼栋ID分页查询 -->
    <select id="selectByBuildingId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        id,
        building_id,
        house_number,
        layout,
        area,
        inner_area,
        floor,
        total_floor,
        orientation,
        decoration,
        house_type,
        price,
        status,
        owner_price,
        description,
        agent_id,
        is_valid,
        created_at,
        updated_at,
        created_by,
        updated_by
        FROM house
        WHERE building_id = #{buildingId}
        AND is_valid = 1
        <!-- 排序规则：按门牌号升序 -->
        ORDER BY house_number ASC
    </select>

    <!-- 统计同一楼栋下相同门牌号的有效房源数量 -->
    <select id="countByBuildingAndNumber" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM house
        WHERE building_id = #{buildingId}
        AND house_number = #{houseNumber}
        AND is_valid = 1  <!-- 只统计有效房源（避免已删除/无效的不影响） -->
    </select>

    <!-- 7. 物理删除 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM house WHERE id = #{id}
    </delete>

</mapper>
