<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="COM.House.Deed.Pavilion.Mapper.HouseLandlordBackupMapper">

    <!-- 通用结果集映射 -->
    <resultMap id="BaseResultMap" type="COM.House.Deed.Pavilion.Entity.HouseLandlordBackup">
        <id column="id" property="id"/>
        <result column="original_id" property="originalId"/>
        <result column="house_id" property="houseId"/>
        <result column="landlord_id" property="landlordId"/>
        <result column="is_main" property="isMain"/>
        <result column="delete_reason" property="deleteReason"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="deleted_by" property="deletedBy"/>
        <result column="backup_time" property="backupTime"/>
    </resultMap>

    <!-- 1. 新增备份记录 -->
    <insert id="insert" parameterType="COM.House.Deed.Pavilion.Entity.HouseLandlordBackup"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO house_landlord_backup (
            original_id,
            house_id,
            landlord_id,
            is_main,
            delete_reason,
            deleted_at,
            deleted_by,
            backup_time
        ) VALUES (
                     #{originalId},
                     #{houseId},
                     #{landlordId},
                     #{isMain},
                     #{deleteReason},
                     #{deletedAt},
                     #{deletedBy},
                     #{backupTime}
                 )
    </insert>

    <!-- 2. 根据备份ID查询 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
            id,
            original_id,
            house_id,
            landlord_id,
            is_main,
            delete_reason,
            deleted_at,
            deleted_by,
            backup_time
        FROM house_landlord_backup
        WHERE id = #{id}
    </select>

    <!-- 3. 根据原关联记录ID查询 -->
    <select id="selectByOriginalId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
            id,
            original_id,
            house_id,
            landlord_id,
            is_main,
            delete_reason,
            deleted_at,
            deleted_by,
            backup_time
        FROM house_landlord_backup
        WHERE original_id = #{originalId}
    </select>

    <!-- 4. 多条件分页查询备份记录 -->
    <select id="selectByCondition" parameterType="COM.House.Deed.Pavilion.DTO.HouseLandlordBackupQueryDTO" resultMap="BaseResultMap">
        SELECT
        id,
        original_id,
        house_id,
        landlord_id,
        is_main,
        delete_reason,
        deleted_at,
        deleted_by,
        backup_time
        FROM house_landlord_backup
        <where>
            <if test="originalId != null">AND original_id = #{originalId}</if>
            <if test="houseId != null">AND house_id = #{houseId}</if>
            <if test="landlordId != null">AND landlord_id = #{landlordId}</if>
            <if test="isMain != null">AND is_main = #{isMain}</if>
            <if test="deletedAtStart != null">AND deleted_at >= #{deletedAtStart}</if>
            <if test="deletedAtEnd != null">AND deleted_at &lt;= #{deletedAtEnd}</if>
        </where>
        ORDER BY deleted_at DESC  <!-- 按删除时间倒序，最新删除的记录优先 -->
    </select>

</mapper>
